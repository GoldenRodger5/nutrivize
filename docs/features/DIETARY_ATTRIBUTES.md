# Dietary Attributes System

This system automatically generates and manages dietary attributes for food items using AI to provide reliable filtering for dietary restrictions and allergens.

## Features

- **Automatic Generation**: New food items automatically get dietary attributes generated by AI
- **Comprehensive Filtering**: Filter foods by dietary restrictions (vegan, vegetarian, gluten-free, etc.) and allergens
- **Visual Indicators**: Food cards display dietary attributes and allergen warnings as badges
- **Bulk Updates**: Script to update existing foods in the database

## Dietary Attributes Structure

Each food item includes:

### Dietary Restrictions
- `vegetarian`: Contains no meat, poultry, or fish
- `vegan`: Contains no animal products at all
- `gluten-free`: Contains no gluten or gluten-containing ingredients
- `dairy-free`: Contains no milk or dairy products
- `halal`: Permissible in Islamic law
- `kosher`: Permissible in Jewish law

### Allergens
- `nuts`: Contains tree nuts
- `peanuts`: Contains peanuts
- `dairy`: Contains milk products
- `eggs`: Contains eggs
- `soy`: Contains soy products
- `shellfish`: Contains shellfish
- `fish`: Contains fish
- `wheat`: Contains wheat
- `sesame`: Contains sesame

### Food Categories
- `fruit`, `vegetable`, `meat`, `seafood`, `dairy`, `grain`, `legume`, `nuts`, `processed`, `beverage`, `condiment`, `dessert`, `oil`

## Usage

### Updating Existing Foods

To update all existing foods without dietary attributes:

```bash
cd backend
python update_dietary_attributes.py
```

**Options:**
- `--dry-run`: Show what would be updated without making changes
- `--batch-size 10`: Process foods in batches (default: 10)
- `--food-id <id>`: Update a specific food by ID

**Examples:**

```bash
# See what would be updated
python update_dietary_attributes.py --dry-run

# Update all foods with smaller batches
python update_dietary_attributes.py --batch-size 5

# Update a specific food
python update_dietary_attributes.py --food-id 507f1f77bcf86cd799439011
```

### Environment Setup

Make sure you have the required environment variables:

```bash
export ANTHROPIC_API_KEY="your-anthropic-api-key"
export GOOGLE_CLOUD_CREDENTIALS_PATH="path/to/credentials.json"
```

### New Food Creation

When creating new foods through the UI or API, dietary attributes are automatically generated. The system:

1. Analyzes the food name and serving information
2. Uses AI to determine dietary restrictions, allergens, and categories
3. Stores the attributes with the food item
4. Uses these attributes for filtering and display

### Frontend Integration

The FoodIndex now includes:

- **Visual badges** showing dietary restrictions and allergens
- **Smart filtering** based on user dietary preferences
- **Automatic filtering** when dietary preferences are set
- **Toggle** to enable/disable dietary filtering

## API Changes

### Food Creation Endpoint

The `/foods` POST endpoint now accepts an optional `dietary_attributes` field:

```json
{
  "name": "Grilled Chicken Breast",
  "serving_size": 100,
  "serving_unit": "g",
  "nutrition": {
    "calories": 165,
    "protein": 31.0,
    "carbs": 0.0,
    "fat": 3.6
  },
  "dietary_attributes": {
    "dietary_restrictions": ["gluten-free", "dairy-free"],
    "allergens": [],
    "food_categories": ["meat", "protein"]
  }
}
```

If `dietary_attributes` is not provided, the system automatically generates them using AI.

### Food Response

All food responses now include the `dietary_attributes` field:

```json
{
  "id": "507f1f77bcf86cd799439011",
  "name": "Grilled Chicken Breast",
  "dietary_attributes": {
    "dietary_restrictions": ["gluten-free", "dairy-free"],
    "allergens": [],
    "food_categories": ["meat"]
  }
}
```

## Benefits

1. **Reliable Filtering**: No more keyword-based filtering that can miss items
2. **Comprehensive Coverage**: AI analyzes ingredients and preparation methods
3. **User Safety**: Clear allergen warnings for users with allergies
4. **Better UX**: Visual indicators help users quickly identify suitable foods
5. **Scalable**: Automatically handles new foods without manual tagging

## Monitoring

The system logs all dietary attribute generation:

```bash
# View logs during food creation
tail -f backend/logs/app.log | grep "dietary"

# Check script progress
python update_dietary_attributes.py --dry-run
```

## Troubleshooting

### Common Issues

1. **AI Service Errors**: Check that `ANTHROPIC_API_KEY` is set correctly
2. **Database Connection**: Ensure MongoDB is running and accessible
3. **Slow Updates**: Use smaller batch sizes for the update script

### Fallback Behavior

If AI generation fails:
- New foods get empty dietary attributes
- Existing foods remain unchanged
- System continues to function with manual attribute setting

### Manual Override

You can manually set dietary attributes when creating or editing foods through the API or by directly updating the database.
