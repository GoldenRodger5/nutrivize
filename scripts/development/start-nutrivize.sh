#!/bin/bash

# Simple Nutrivize V2 Development Startup Script
echo "ðŸš€ Starting Nutrivize V2 Development Environment..."

# Check and kill processes on ports
echo "ðŸ” Checking and freeing ports..."
kill -9 $(lsof -ti:8000,5173) 2>/dev/null
sleep 2

# Set up environment variables for local development
echo "ï¿½ Setting up environment..."
export ENVIRONMENT="local"

# Create/update the .env.local file with correct values
echo "ðŸ“ Setting up .env.local file..."
cat > backend/.env.local << EOL
# Local development environment variables
MONGODB_URL="mongodb+srv://isaacmineo:1vWVKLtI4cFn1LNN@nutrivize.rbj6ly6.mongodb.net/nutrivize_v2?retryWrites=true&w=majority&tls=true&tlsAllowInvalidCertificates=true"
ANTHROPIC_API_KEY="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"
FIREBASE_PROJECT_ID="food-tracker-6096d"
ENVIRONMENT="local"
DEBUG=true
FIREBASE_SERVICE_ACCOUNT_BASE64="eyJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsICJwcm9qZWN0X2lkIjogImZvb2QtdHJhY2tlci02MDk2ZCIsICJwcml2YXRlX2tleV9pZCI6ICJjMTZiZWQ0ZjZjMjk0ZGE3Mzk1ZTE4YzgyMTAzNTI2MGEyNDA5YzBlIiwgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFEVDh0TkNxeWV5UnlLb1xubUxoYTFNT0RyRXBvZldBdFN5MW92RW5VQkpYRmZXZ2xOVjRheG0zQ0c3OW1ENlc5SUxUM1QzY1orek1WLzlFWVxucE03OXNTTGo0UkE3emV4K093a3VrbUdGWGdwem1zMGZWRGpYbkVpdE1NYW5QZnhOaTRpb3hMQVFkeC9MQ3NPTVxuWG1ObElvN1h1RGlYNHdrNkx6VFovWjVmbWxBY1FRQTEwWmNMSnhBWFRuWkFZQ2JOZHoyT2lHWE1ndlpLMzNSM1xuVVlCYy9BcHZlZ0t0WGlhV3JhTXNaNmN3UmgwbmNEVGxaK1FISkJyTDN6SDdtWThacFFPL2hMMGcxWXBROTk4clxuTGI1TndiOWNXS1JPYW9MNW1vYmJwQXJpa0lzZnNwOVZ2dTBzTEpwelh1N1V5aDhWdDNza3dqckxBYWxUWllUd1xuMW1qbGxUbmRBZ01CQUFFQ2dnRUFEZ3NmUjVVdm9wQm5SUmUvMHBHelBFL2VLeFNqbXNNVzFaQWtSMTU1bXRLM1xubHd4YnpMREY5UUEwM21TK09jME55aTdRSlhJcElHSnZ0U2kyWi9qWDV2c1pEcW9zdDcxRTIwZUVnZUc4ZkZsQ1xuUkllTTR3azB1c1VEeXdxbXlkWXJaK202QU1Pd3JnQTRsTVJzU3lwb244S0ZGd3RLZEcxTVQvNzBhUTROUnpoQ1xuRG1XeFhneGVZczlRM3cvWXhGc0g3a1FwMzhGUnRMN2ppR3VLa1pOYUE5aWdVaFJ0VnZqRVE0amF1WHYvcEZxZFxuYWQzRUUxYVpBUWdDWDVFSGhGTkM5V1RMR25PV1BvYUJVMm5BVkc5azRVdXB4eEo2MVphWEk3dmgzQ2JmSFZhdlxuaXZhamFWTXZLa09CSFBBVDdyOTNSRzVXNjhyM0pGdUVhMU8rVFhXZHdRS0JnUUR6eDVSNURad3lzTDBiY00rS1xuQ21XMkJpOFBUTVQ5R3J3Y0h2eFRPREE4Y0FCa0ZXWTlUdzA1SWRxc3J2Q0gxYWMxM2Y0NEVBTkorUzB0RHcvMlxuYmRMU2lZaGpIdXkwZEF1ZWVhc2w3dTZKRUorOExSd3VYOXhpbm14di9sK04rK1drVjU2MVgzR3VWenNMVGRPSlxudU5qSHJ1aFRHM1FIdnpnbVN1UFNpcHZQandLQmdRRGVrc0h4RHpoeUd6NGhqbkFVZng1alZGS2g2czFiVG5uVFxuU3Mzcys4cnV4cmxUb2tERDBoMDBmbDBwNkZHbVJ2NUh4ZHVNeGRPdks2M2JXZkdBeGltc3BRV1E4eFZRN1liMFxucGVwU1RJckpaenUrZHl5alc4ZjBxQUVoM3BWQXptQ0FSYU04NVQ1S0JTZnZNcERaV0xVNGF5VVMyd1ZBZHBkQVxuY0JQNkZNRHAwd0tCZ0dTeVdSc1R5eVNKS3VRdDJoeWNKTjFtZW9Qb1l5cGxvN1E5L0Y1bnhFMEN1cmFjdkVtd1xuNExacnpJY3VELzhiK3VEZVhRZE5YZjV0WmdMSnlQOHk2RFc5UjlBaDB3YkxOSTEybG9LcHluQmxwSVczWUgrclxuYXo1MVVEZUdySFBhekVYeFI0YUY4VkJoaWVzbWI2M2c0L0sveGdtbU9teUV5UzNRRzRFNWJoanpBb0dBTWYrQlxudGFjWHBQcGRzS2dRb1dvVTUzZFB3TFBBUWR5VkhWUFdnbi9sakZIejI4ZTlDTUF3YzFSWGxVeHMydzlqbTdma1xuby9Ea3Bwc0hTUmtoV1M0cXVtK3ZtbW9neGJjMTg4czVvaGN6cmg2VW15cW1TbVFadk9ub3B6VWJEaDNPSzhKNFxuOHZzRVRSaHZhaHBQMDZOTHdrcS9YMGI0SFEwRzJTRFVPLzloZnFVQ2dZRUFnUEE1cG43d0FSSDA5dEkrUndqMVxucE1tNVhYdDMyek5QSkpJZlZDVlhLUXQyU1ZiQXFOeGs5bnVKOVJxZ0VXdEhuVXVKZ0hvTW80MytTdUdHREcweFxuRGhmUXVINnp5U0F6OWZ3RUl1OVl2bnJ3SlBKdjR4UWFXamF2cG1XeXhqbnpaek03OEJ0QTBIY0x4L2F5SUtFSFxuNGI0Yk1rNWJmQXBieXpYcWxnWS9DaWs9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tIiwgImNsaWVudF9lbWFpbCI6ICJudXRyaXZpemVAZm9vZC10cmFja2VyLTYwOTZkLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwgImNsaWVudF9pZCI6ICIxMTM5NjkyNjg1Njg1NzMwMTM4MjciLCAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLCAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLCAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9udXRyaXZpemUlNDBmb29kLXRyYWNrZXItNjA5NmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCAidW5pdmVyc2VfZG9tYWluIjogImdvb2dsZWFwaXMuY29tIn0="
GOOGLE_CLOUD_VISION_CREDENTIALS_BASE64="eyJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsICJwcm9qZWN0X2lkIjogImZvb2QtdHJhY2tlci02MDk2ZCIsICJwcml2YXRlX2tleV9pZCI6ICJjMTZiZWQ0ZjZjMjk0ZGE3Mzk1ZTE4YzgyMTAzNTI2MGEyNDA5YzBlIiwgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFEVDh0TkNxeWV5UnlLb1xubUxoYTFNT0RyRXBvZldBdFN5MW92RW5VQkpYRmZXZ2xOVjRheG0zQ0c3OW1ENlc5SUxUM1QzY1orek1WLzlFWVxucE03OXNTTGo0UkE3emV4K093a3VrbUdGWGdwem1zMGZWRGpYbkVpdE1NYW5QZnhOaTRpb3hMQVFkeC9MQ3NPTVxuWG1ObElvN1h1RGlYNHdrNkx6VFovWjVmbWxBY1FRQTEwWmNMSnhBWFRuWkFZQ2JOZHoyT2lHWE1ndlpLMzNSM1xuVVlCYy9BcHZlZ0t0WGlhV3JhTXNaNmN3UmgwbmNEVGxaK1FISkJyTDN6SDdtWThacFFPL2hMMGcxWXBROTk4clxuTGI1TndiOWNXS1JPYW9MNW1vYmJwQXJpa0lzZnNwOVZ2dTBzTEpwelh1N1V5aDhWdDNza3dqckxBYWxUWllUd1xuMW1qbGxUbmRBZ01CQUFFQ2dnRUFEZ3NmUjVVdm9wQm5SUmUvMHBHelBFL2VLeFNqbXNNVzFaQWtSMTU1bXRLM1xubHd4YnpMREY5UUEwM21TK09jME55aTdRSlhJcElHSnZ0U2kyWi9qWDV2c1pEcW9zdDcxRTIwZUVnZUc4ZkZsQ1xuUkllTTR3azB1c1VEeXdxbXlkWXJaK202QU1Pd3JnQTRsTVJzU3lwb244S0ZGd3RLZEcxTVQvNzBhUTROUnpoQ1xuRG1XeFhneGVZczlRM3cvWXhGc0g3a1FwMzhGUnRMN2ppR3VLa1pOYUE5aWdVaFJ0VnZqRVE0amF1WHYvcEZxZFxuYWQzRUUxYVpBUWdDWDVFSGhGTkM5V1RMR25PV1BvYUJVMm5BVkc5azRVdXB4eEo2MVphWEk3dmgzQ2JmSFZhdlxuaXZhamFWTXZLa09CSFBBVDdyOTNSRzVXNjhyM0pGdUVhMU8rVFhXZHdRS0JnUUR6eDVSNURad3lzTDBiY00rS1xuQ21XMkJpOFBUTVQ5R3J3Y0h2eFRPREE4Y0FCa0ZXWTlUdzA1SWRxc3J2Q0gxYWMxM2Y0NEVBTkorUzB0RHcvMlxuYmRMU2lZaGpIdXkwZEF1ZWVhc2w3dTZKRUorOExSd3VYOXhpbm14di9sK04rK1drVjU2MVgzR3VWenNMVGRPSlxudU5qSHJ1aFRHM1FIdnpnbVN1UFNpcHZQandLQmdRRGVrc0h4RHpoeUd6NGhqbkFVZng1alZGS2g2czFiVG5uVFxuU3Mzcys4cnV4cmxUb2tERDBoMDBmbDBwNkZHbVJ2NUh4ZHVNeGRPdks2M2JXZkdBeGltc3BRV1E4eFZRN1liMFxucGVwU1RJckpaenUrZHl5alc4ZjBxQUVoM3BWQXptQ0FSYU04NVQ1S0JTZnZNcERaV0xVNGF5VVMyd1ZBZHBkQVxuY0JQNkZNRHAwd0tCZ0dTeVdSc1R5eVNKS3VRdDJoeWNKTjFtZW9Qb1l5cGxvN1E5L0Y1bnhFMEN1cmFjdkVtd1xuNExacnpJY3VELzhiK3VEZVhRZE5YZjV0WmdMSnlQOHk2RFc5UjlBaDB3YkxOSTEybG9LcHluQmxwSVczWUgrclxuYXo1MVVEZUdySFBhekVYeFI0YUY4VkJoaWVzbWI2M2c0L0sveGdtbU9teUV5UzNRRzRFNWJoanpBb0dBTWYrQlxudGFjWHBQcGRzS2dRb1dvVTUzZFB3TFBBUWR5VkhWUFdnbi9sakZIejI4ZTlDTUF3YzFSWGxVeHMydzlqbTdma1xuby9Ea3Bwc0hTUmtoV1M0cXVtK3ZtbW9neGJjMTg4czVvaGN6cmg2VW15cW1TbVFadk9ub3B6VWJEaDNPSzhKNFxuOHZzRVRSaHZhaHBQMDZOTHdrcS9YMGI0SFEwRzJTRFVPLzloZnFVQ2dZRUFnUEE1cG43d0FSSDA5dEkrUndqMVxucE1tNVhYdDMyek5QSkpJZlZDVlhLUXQyU1ZiQXFOeGs5bnVKOVJxZ0VXdEhuVXVKZ0hvTW80MytTdUdHREcweFxuRGhmUXVINnp5U0F6OWZ3RUl1OVl2bnJ3SlBKdjR4UWFXamF2cG1XeXhqbnpaek03OEJ0QTBIY0x4L2F5SUtFSFxuNGI0Yk1rNWJmQXBieXpYcWxnWS9DaWs9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tIiwgImNsaWVudF9lbWFpbCI6ICJudXRyaXZpemVAZm9vZC10cmFja2VyLTYwOTZkLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwgImNsaWVudF9pZCI6ICIxMTM5NjkyNjg1Njg1NzMwMTM4MjciLCAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLCAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLCAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9udXRyaXZpemUlNDBmb29kLXRyYWNrZXItNjA5NmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCAidW5pdmVyc2VfZG9tYWluIjogImdvb2dsZWFwaXMuY29tIn0="
SECRET_KEY="nutrivize-production-secret-key-2025-super-secure-key"
FRONTEND_URL="http://localhost:5173"
EOL

# Start backend and frontend
echo "ï¿½ Starting Backend (FastAPI) on port 8000..."
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &
BACKEND_PID=$!
cd ..

echo "ðŸŽ¨ Starting Frontend (Vite) on port 5173..."
cd frontend 
npm run dev &
FRONTEND_PID=$!
cd ..

echo ""
echo "ðŸŽ‰ Nutrivize V2 Development Environment Started!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ”§ Backend API:  http://localhost:8000"
echo "ðŸŒ Frontend App: http://localhost:5173"
echo "ðŸ“Š API Docs:     http://localhost:8000/docs"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Handle Ctrl+C
cleanup() {
    echo "ðŸ›‘ Shutting down services..."
    kill -9 $BACKEND_PID $FRONTEND_PID 2>/dev/null
    echo "âœ… All services stopped"
    exit 0
}

trap cleanup INT TERM

# Wait for user interrupt
wait
