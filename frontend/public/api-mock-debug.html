<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrivize API Mock Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #8E2DE2;
            margin-bottom: 20px;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        button {
            background: #8E2DE2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #4A00E0;
        }
        pre {
            background: #f1f1f1;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 400px;
        }
        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .urls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .url-btn {
            background: #4A00E0;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Nutrivize API Mock Debug</h1>
    
    <div class="debug-panel">
        <h2>API Test</h2>
        <p>Use this tool to diagnose API connectivity issues and test the mock system.</p>
        
        <div class="urls">
            <button class="url-btn" data-url="/foods">GET /foods</button>
            <button class="url-btn" data-url="/logs?date=2023-04-25">GET /logs?date=...</button>
            <button class="url-btn" data-url="/logs/range?start_date=2023-04-20&end_date=2023-04-27">GET /logs/range</button>
            <button class="url-btn" data-url="/meal-plans/active">GET /meal-plans/active</button>
            <button class="url-btn" data-url="/goals/active">GET /goals/active</button>
            <button class="url-btn" data-url="/goals">GET /goals</button>
            <button class="url-btn" data-url="/users/profile">GET /users/profile</button>
            <button class="url-btn" data-url="/api/insights">GET /api/insights</button>
        </div>
        
        <div>
            <input type="text" id="api-url" placeholder="API URL" style="width: 300px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
            <select id="method" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="GET">GET</option>
                <option value="POST">POST</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
            </select>
        </div>
        
        <div style="margin: 10px 0;">
            <textarea id="request-body" placeholder="Request body (JSON)" style="width: 100%; height: 100px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;"></textarea>
        </div>
        
        <button id="test-api">Test API Call</button>
        <button id="test-mock">Test Mock System</button>
        <button id="activate-mock">Activate Mock System</button>
        
        <div id="status-container"></div>
        
        <h3>Response:</h3>
        <pre id="response"></pre>
    </div>
    
    <div class="debug-panel">
        <h2>Setup Mock API</h2>
        <p>This will set up a global mock interceptor for fetch and axios calls.</p>
        <button id="setup-mock">Set Up Mock API</button>
        <div id="mock-status" class="status"></div>
    </div>
    
    <div class="debug-panel">
        <h2>Redirect to App</h2>
        <p>After setting up mocks, try loading the app again:</p>
        <button id="go-to-app">Go to App</button>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const responseContainer = document.getElementById('response');
        const mockStatus = document.getElementById('mock-status');
        
        // Set up click handlers for URL buttons
        document.querySelectorAll('.url-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('api-url').value = btn.dataset.url;
            });
        });
        
        // Test API button
        document.getElementById('test-api').addEventListener('click', async () => {
            const url = document.getElementById('api-url').value;
            const method = document.getElementById('method').value;
            const body = document.getElementById('request-body').value;
            
            if (!url) {
                showStatus('Please enter an API URL', 'error');
                return;
            }
            
            try {
                showStatus(`Sending ${method} request to ${url}...`, 'info');
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (method !== 'GET' && body) {
                    options.body = body;
                }
                
                const baseUrl = 'http://localhost:5001'; // Adjust based on your API URL
                const response = await fetch(`${baseUrl}${url}`, options);
                const data = await response.json();
                
                showStatus(`Request successful (${response.status})`, 'success');
                responseContainer.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                responseContainer.textContent = error.stack || error.message;
            }
        });
        
        // Test mock system
        document.getElementById('test-mock').addEventListener('click', async () => {
            const url = document.getElementById('api-url').value;
            
            if (!url) {
                showStatus('Please enter an API URL', 'error');
                return;
            }
            
            try {
                showStatus(`Testing mock for ${url}...`, 'info');
                
                // Check if mock system is available
                if (!window.__NUTRIVIZE_MOCK_SYSTEM__) {
                    showStatus('Mock system not available. Please set it up first.', 'error');
                    return;
                }
                
                const mockResponse = window.__NUTRIVIZE_MOCK_SYSTEM__.findMockForUrl(url);
                
                if (mockResponse === null) {
                    showStatus(`No mock found for ${url}`, 'error');
                } else {
                    showStatus(`Mock found for ${url}`, 'success');
                }
                
                responseContainer.textContent = JSON.stringify(mockResponse, null, 2);
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                responseContainer.textContent = error.stack || error.message;
            }
        });
        
        // Set up mock API
        document.getElementById('setup-mock').addEventListener('click', async () => {
            try {
                mockStatus.textContent = 'Setting up mock system...';
                mockStatus.className = 'status';
                
                // Dynamically load mockData.js
                const script = document.createElement('script');
                script.src = '/mockData.js';
                script.onload = () => {
                    // Once loaded, set up the mock system
                    if (typeof useMockData === 'function') {
                        const cleanup = useMockData(true);
                        window.__MOCK_CLEANUP__ = cleanup;
                        
                        mockStatus.textContent = 'Mock system set up successfully! You can now test API calls or go to the app.';
                        mockStatus.className = 'status success';
                    } else {
                        mockStatus.textContent = 'Error: useMockData function not found in mockData.js';
                        mockStatus.className = 'status error';
                    }
                };
                script.onerror = () => {
                    mockStatus.textContent = 'Error loading mockData.js. Make sure it exists in the public directory.';
                    mockStatus.className = 'status error';
                };
                
                document.head.appendChild(script);
            } catch (error) {
                mockStatus.textContent = `Error: ${error.message}`;
                mockStatus.className = 'status error';
            }
        });
        
        // Activate pre-existing mock
        document.getElementById('activate-mock').addEventListener('click', async () => {
            try {
                // Find the mock data function in the global scope
                if (window.useMockData) {
                    const cleanup = window.useMockData(true);
                    window.__MOCK_CLEANUP__ = cleanup;
                    showStatus('Mock system activated', 'success');
                } else {
                    // Create a basic mock system
                    const originalFetch = window.fetch;
                    window.fetch = function(url, options) {
                        console.log(`[EMERGENCY MOCK] Intercepted fetch to: ${url}`);
                        
                        // Return a basic success response for all API requests
                        if (url.includes('/api/') || url.includes('/users/') || url.match(/\/[a-zA-Z0-9-_]+\//)) {
                            console.log(`[EMERGENCY MOCK] Returning success for: ${url}`);
                            return Promise.resolve({
                                ok: true,
                                status: 200,
                                json: () => Promise.resolve({})
                            });
                        }
                        
                        return originalFetch(url, options);
                    };
                    
                    showStatus('Emergency mock system activated', 'success');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        });
        
        // Go to app
        document.getElementById('go-to-app').addEventListener('click', () => {
            window.location.href = '/';
        });
        
        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            statusContainer.innerHTML = '';
            statusContainer.appendChild(statusDiv);
        }
    </script>
</body>
</html> 